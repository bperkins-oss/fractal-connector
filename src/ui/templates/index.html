<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#fbfbfd">
    <title>Fractal Connector</title>
    <style>
        /* ============================================
           APPLE + BAUHAUS DESIGN
           Clean, minimal, geometric, functional
           ============================================ */

        :root {
            /* Apple-inspired palette */
            --white: #ffffff;
            --bg-primary: #fbfbfd;
            --bg-secondary: #f5f5f7;
            --bg-tertiary: #e8e8ed;

            /* Text hierarchy */
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-tertiary: #86868b;

            /* Apple blue */
            --blue: #0071e3;
            --blue-hover: #0077ed;
            --blue-light: rgba(0, 113, 227, 0.1);

            /* Semantic */
            --green: #34c759;
            --green-light: rgba(52, 199, 89, 0.12);
            --red: #ff3b30;
            --red-light: rgba(255, 59, 48, 0.12);

            /* Borders & shadows */
            --border: rgba(0, 0, 0, 0.06);
            --border-dark: rgba(0, 0, 0, 0.1);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.12);

            /* Typography - SF Pro style */
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;

            /* Spacing - 8pt grid */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            --space-16: 64px;

            /* Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 18px;
            --radius-xl: 24px;
        }

        /* Reset */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            font-size: 17px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: var(--font);
            font-weight: 400;
            line-height: 1.47059;
            letter-spacing: -0.022em;
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
        }

        /* Layout */
        .app {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Clean Apple style */
        .sidebar {
            width: 260px;
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
        }

        .sidebar-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--text-primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            color: var(--white);
        }

        .logo-text {
            font-size: 21px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        /* Navigation */
        .sidebar-nav {
            flex: 1;
            padding: var(--space-4);
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: var(--space-6);
        }

        .nav-title {
            padding: var(--space-2) var(--space-3);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--blue-light);
            color: var(--blue);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            opacity: 0.8;
        }

        /* Status footer */
        .sidebar-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--border);
        }

        .status {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-tertiary);
        }

        .status-dot.online {
            background: var(--green);
        }

        .status-dot.offline {
            background: var(--red);
        }

        .status-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Main content */
        .main {
            flex: 1;
            margin-left: 260px;
            background: var(--bg-primary);
        }

        .main-header {
            height: 64px;
            padding: 0 var(--space-10);
            background: rgba(251, 251, 253, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .main-title {
            font-size: 21px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .main-content {
            padding: var(--space-10);
            max-width: 880px;
        }

        /* Sections */
        .section {
            margin-bottom: var(--space-12);
        }

        .section-header {
            margin-bottom: var(--space-5);
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .section-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
        }

        /* Cards - Apple style */
        .card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .card-body {
            padding: var(--space-6);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-5);
        }

        .form-group {
            margin-bottom: var(--space-5);
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .form-input {
            width: 100%;
            height: 44px;
            padding: 0 var(--space-4);
            background: var(--bg-secondary);
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 17px;
            color: var(--text-primary);
            outline: none;
            transition: all 0.2s ease;
        }

        .form-input:hover {
            background: var(--bg-tertiary);
        }

        .form-input:focus {
            background: var(--white);
            border-color: var(--blue);
            box-shadow: 0 0 0 3px var(--blue-light);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        /* Buttons - Apple style */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            height: 44px;
            padding: 0 var(--space-6);
            font-family: inherit;
            font-size: 17px;
            font-weight: 500;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        .btn-primary {
            background: var(--blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--blue-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            height: 36px;
            padding: 0 var(--space-3);
        }

        .btn-ghost:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            background: transparent;
            color: var(--text-tertiary);
            border-radius: var(--radius-sm);
        }

        .btn-icon:hover {
            background: var(--red-light);
            color: var(--red);
        }

        .btn-group {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-6);
        }

        /* Plugin grid - Bauhaus geometric */
        .plugin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: var(--space-3);
        }

        .plugin-item {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .plugin-item:hover {
            background: var(--bg-tertiary);
        }

        .plugin-item.selected {
            background: var(--blue-light);
            border-color: var(--blue);
        }

        .plugin-icon {
            width: 40px;
            height: 40px;
            background: var(--white);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-sm);
        }

        .plugin-item.selected .plugin-icon {
            background: var(--blue);
            color: var(--white);
            box-shadow: none;
        }

        .plugin-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            padding: 0 var(--space-1);
        }

        .plugin-item.selected .plugin-name {
            color: var(--blue);
        }

        /* Credentials panel */
        .credentials-panel {
            margin-top: var(--space-5);
            padding: var(--space-5);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .credentials-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: var(--space-4);
        }

        /* Source list */
        .source-list {
            display: flex;
            flex-direction: column;
        }

        .source-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--border);
            transition: background 0.15s ease;
        }

        .source-item:last-child {
            border-bottom: none;
        }

        .source-item:hover {
            background: var(--bg-secondary);
        }

        .source-info {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .source-icon {
            width: 44px;
            height: 44px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .source-name {
            font-size: 17px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .source-type {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .source-actions {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .source-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 13px;
            font-weight: 500;
            color: var(--green);
        }

        .source-status::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--green);
            border-radius: 50%;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-8);
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-4);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .empty-text {
            font-size: 17px;
            color: var(--text-tertiary);
        }

        /* Alerts */
        .alert {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 500;
            margin-bottom: var(--space-5);
        }

        .alert-success {
            background: var(--green-light);
            color: #1a7f37;
        }

        .alert-error {
            background: var(--red-light);
            color: #d1242f;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
        }

        .modal-backdrop.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 520px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.95) translateY(10px);
            transition: transform 0.25s ease;
        }

        .modal-backdrop.open .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 19px;
            font-weight: 600;
        }

        .modal-body {
            padding: var(--space-6);
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-description {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: var(--space-5);
        }

        /* Toggle list */
        .toggle-list {
            display: flex;
            flex-direction: column;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--border);
        }

        .toggle-row:last-child {
            border-bottom: none;
        }

        .toggle-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .toggle-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .toggle-name {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* iOS-style toggle */
        .toggle-switch {
            width: 51px;
            height: 31px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            cursor: pointer;
            position: relative;
            transition: background 0.25s ease;
        }

        .toggle-switch.on {
            background: var(--green);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 27px;
            height: 27px;
            background: var(--white);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transition: transform 0.25s ease;
        }

        .toggle-switch.on::after {
            transform: translateX(20px);
        }

        /* Utilities */
        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main { margin-left: 0; }
            .form-grid { grid-template-columns: 1fr; }
            .plugin-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">F</div>
                    <span class="logo-text">Fractal</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-title">General</div>
                    <a href="#" class="nav-item active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                        Dashboard
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-title">Settings</div>
                    <a href="#" class="nav-item" onclick="openSettings(); return false;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                        Connectors
                    </a>
                    <a href="/logout" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
                        Sign Out
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="status">
                    <span class="status-dot" id="statusDot"></span>
                    <span class="status-label" id="statusText">Connecting...</span>
                </div>
            </div>
        </aside>

        <main class="main">
            <header class="main-header">
                <h1 class="main-title">Dashboard</h1>
                <button class="btn btn-secondary" onclick="openSettings()">Settings</button>
            </header>

            <div class="main-content">
                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Cloud Connection</h2>
                        <p class="section-subtitle">Connect to your Fractal Cloud instance</p>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div id="fractalMessage" class="alert hidden"></div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Server URL</label>
                                    <input type="url" class="form-input" id="fractalUrl" placeholder="wss://fractal.example.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">API Key</label>
                                    <input type="password" class="form-input" id="apiKey" placeholder="Enter API key">
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="saveFractalConfig()">Save</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Data Sources</h2>
                        <p class="section-subtitle">Add a new data source connection</p>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div id="addSourceMessage" class="alert hidden"></div>
                            <div class="form-group">
                                <label class="form-label">Source Type</label>
                                <div class="plugin-grid" id="pluginGrid"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-input" id="sourceName" placeholder="My Database">
                            </div>
                            <div id="credentialFields" class="credentials-panel hidden">
                                <div class="credentials-title">Connection Details</div>
                                <div id="credentialFieldsContainer"></div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="testConnection()">Test</button>
                                <button class="btn btn-primary" onclick="addSource()">Add Source</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="section">
                    <div class="section-header">
                        <h2 class="section-title">Active Sources</h2>
                        <p class="section-subtitle">Your connected data sources</p>
                    </div>
                    <div class="card">
                        <div id="sourceList" class="source-list"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div class="modal-backdrop" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Connectors</h2>
                <button class="btn btn-ghost" onclick="closeSettings()">Done</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">Enable or disable connector types</p>
                <div class="toggle-list" id="pluginToggleList"></div>
            </div>
        </div>
    </div>

    <script>
        let plugins = [];
        let selectedPlugin = null;
        let enabledPlugins = JSON.parse(localStorage.getItem('enabledPlugins') || '{}');

        const icons = {
            'description': 'ðŸ“„', 'cloud_download': 'â˜ï¸', 'api': 'ðŸ”Œ', 'storage': 'ðŸ’¾',
            'dns': 'ðŸ—„ï¸', 'forest': 'ðŸŒ²', 'ac_unit': 'â„ï¸', 'database': 'ðŸ—ƒï¸',
            'search': 'ðŸ”', 'memory': 'ðŸ’½', 'cloud': 'â˜ï¸', 'cloud_circle': 'â˜ï¸',
            'cloud_queue': 'â˜ï¸', 'table_chart': 'ðŸ“Š', 'folder_shared': 'ðŸ“',
            'stream': 'ðŸ“¡', 'show_chart': 'ðŸ“ˆ', 'trending_up': 'ðŸ“ˆ',
            'analytics': 'ðŸ“Š', 'account_balance': 'ðŸ¦', 'insights': 'ðŸ’¡',
            'bar_chart': 'ðŸ“Š', 'query_stats': 'ðŸ“‰', 'currency_bitcoin': 'â‚¿',
            'paid': 'ðŸ’°', 'newspaper': 'ðŸ“°', 'gavel': 'âš–ï¸', 'extension': 'ðŸ§©'
        };

        async function init() {
            await loadPlugins();
            await loadSources();
            await loadFractalConfig();
            updateStatus();
            setInterval(updateStatus, 5000);
        }

        async function loadPlugins() {
            try {
                const res = await fetch('/api/plugins');
                plugins = await res.json();
                plugins.forEach(p => { if (enabledPlugins[p.id] === undefined) enabledPlugins[p.id] = true; });
                localStorage.setItem('enabledPlugins', JSON.stringify(enabledPlugins));
                renderPluginGrid();
                renderPluginToggles();
            } catch (e) { console.error('Failed to load plugins:', e); }
        }

        function renderPluginGrid() {
            document.getElementById('pluginGrid').innerHTML = plugins.filter(p => enabledPlugins[p.id]).map(p => `
                <div class="plugin-item ${selectedPlugin?.id === p.id ? 'selected' : ''}" onclick="selectPlugin('${p.id}')">
                    <div class="plugin-icon">${icons[p.icon] || 'ðŸ§©'}</div>
                    <div class="plugin-name">${p.name}</div>
                </div>
            `).join('');
        }

        function renderPluginToggles() {
            document.getElementById('pluginToggleList').innerHTML = plugins.map(p => `
                <div class="toggle-row">
                    <div class="toggle-info">
                        <div class="toggle-icon">${icons[p.icon] || 'ðŸ§©'}</div>
                        <span class="toggle-name">${p.name}</span>
                    </div>
                    <div class="toggle-switch ${enabledPlugins[p.id] ? 'on' : ''}" onclick="togglePlugin('${p.id}')"></div>
                </div>
            `).join('');
        }

        function togglePlugin(id) {
            enabledPlugins[id] = !enabledPlugins[id];
            localStorage.setItem('enabledPlugins', JSON.stringify(enabledPlugins));
            renderPluginGrid();
            renderPluginToggles();
        }

        function selectPlugin(id) {
            selectedPlugin = plugins.find(p => p.id === id);
            renderPluginGrid();
            renderCredentialFields();
        }

        function renderCredentialFields() {
            const container = document.getElementById('credentialFieldsContainer');
            const wrapper = document.getElementById('credentialFields');
            if (!selectedPlugin?.credential_fields?.length) { wrapper.classList.add('hidden'); return; }
            wrapper.classList.remove('hidden');
            container.innerHTML = selectedPlugin.credential_fields.map(f => {
                const input = f.type === 'select'
                    ? `<select class="form-input" id="cred_${f.name}">${f.options.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}</select>`
                    : `<input type="${f.type === 'password' ? 'password' : 'text'}" class="form-input" id="cred_${f.name}" placeholder="${f.placeholder || ''}" value="${f.default || ''}">`;
                return `<div class="form-group"><label class="form-label">${f.label}${f.required ? ' *' : ''}</label>${input}</div>`;
            }).join('');
        }

        function getCredentialValues() {
            if (!selectedPlugin) return {};
            return Object.fromEntries(selectedPlugin.credential_fields.map(f => [f.name, document.getElementById(`cred_${f.name}`)?.value]));
        }

        async function testConnection() {
            if (!selectedPlugin) return showMessage('addSourceMessage', 'Select a source type', 'error');
            try {
                const res = await fetch('/api/sources/test', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ plugin_type: selectedPlugin.id, credentials: getCredentialValues() }) });
                const data = await res.json();
                showMessage('addSourceMessage', data.message, data.success ? 'success' : 'error');
            } catch (e) { showMessage('addSourceMessage', 'Connection failed', 'error'); }
        }

        async function addSource() {
            if (!selectedPlugin) return showMessage('addSourceMessage', 'Select a source type', 'error');
            const name = document.getElementById('sourceName').value;
            if (!name) return showMessage('addSourceMessage', 'Enter a name', 'error');
            try {
                const res = await fetch('/api/sources', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ plugin_type: selectedPlugin.id, name, credentials: getCredentialValues() }) });
                const data = await res.json();
                if (data.success) { showMessage('addSourceMessage', 'Source added', 'success'); document.getElementById('sourceName').value = ''; await loadSources(); }
                else showMessage('addSourceMessage', data.error, 'error');
            } catch (e) { showMessage('addSourceMessage', 'Failed to add source', 'error'); }
        }

        async function loadSources() {
            try { const res = await fetch('/api/sources'); renderSources(await res.json()); } catch (e) {}
        }

        function renderSources(sources) {
            const list = document.getElementById('sourceList');
            if (!sources.length) { list.innerHTML = `<div class="empty-state"><div class="empty-icon">ðŸ“¦</div><p class="empty-text">No data sources connected</p></div>`; return; }
            list.innerHTML = sources.map(s => {
                const plugin = plugins.find(p => p.id === s.plugin_type);
                return `<div class="source-item"><div class="source-info"><div class="source-icon">${icons[plugin?.icon] || 'ðŸ§©'}</div><div><div class="source-name">${s.name}</div><div class="source-type">${plugin?.name || s.plugin_type}</div></div></div><div class="source-actions"><span class="source-status">Active</span><button class="btn btn-icon" onclick="deleteSource('${s.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="18" height="18"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button></div></div>`;
            }).join('');
        }

        async function deleteSource(id) { if (!confirm('Remove this source?')) return; await fetch(`/api/sources/${id}`, { method: 'DELETE' }); await loadSources(); }

        async function loadFractalConfig() {
            try { const res = await fetch('/api/config/fractal'); const config = await res.json(); document.getElementById('fractalUrl').value = config.url || ''; if (config.has_api_key) document.getElementById('apiKey').placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'; } catch (e) {}
        }

        async function saveFractalConfig() {
            const body = {}; const url = document.getElementById('fractalUrl').value; const apiKey = document.getElementById('apiKey').value;
            if (url) body.url = url; if (apiKey) body.api_key = apiKey;
            try { await fetch('/api/config/fractal', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) }); showMessage('fractalMessage', 'Saved', 'success'); }
            catch (e) { showMessage('fractalMessage', 'Failed to save', 'error'); }
        }

        async function updateStatus() {
            try { const res = await fetch('/api/status'); const status = await res.json(); document.getElementById('statusDot').className = status.fractal_connected ? 'status-dot online' : 'status-dot offline'; document.getElementById('statusText').textContent = status.fractal_connected ? 'Connected' : 'Disconnected'; } catch (e) {}
        }

        function openSettings() { document.getElementById('settingsModal').classList.add('open'); }
        function closeSettings() { document.getElementById('settingsModal').classList.remove('open'); }
        document.getElementById('settingsModal').addEventListener('click', e => { if (e.target.id === 'settingsModal') closeSettings(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeSettings(); });

        function showMessage(id, msg, type) { const el = document.getElementById(id); el.textContent = msg; el.className = `alert alert-${type}`; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 3000); }

        init();
    </script>
</body>
</html>
